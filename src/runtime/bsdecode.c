#include "bsdecode.h"

#include <stdint.h>
#include <stdlib.h>

typedef struct {
    uint8_t left;
    uint8_t right;
    uint8_t symbol;
}
hh2_BsNode;

static hh2_BsNode const hh2_BsTree[] = {
                      /* ndx | weight | bits               */
    {  1,  90,    0}, /*   0 | 262086 |                    */
    {  2,   9,    0}, /*   1 | 107559 |                    */
    {  3,   8,    0}, /*   2 |  50330 |                    */
    {  4,   5,    0}, /*   3 |  24229 |                    */
    {  0,   0,  't'}, /*   4 |  12052 | 0000               */
    {  6,   7,    0}, /*   5 |  12177 |                    */
    {  0,   0,  'm'}, /*   6 |   5841 | 00010              */
    {  0,   0,  '0'}, /*   7 |   6336 | 00011              */
    {  0,   0,  ' '}, /*   8 |  26101 | 001                */
    { 10,  51,    0}, /*   9 |  57229 |                    */
    { 11,  14,    0}, /*  10 |  26635 |                    */
    { 12,  13,    0}, /*  11 |  13208 |                    */
    {  0,   0,  '.'}, /*  12 |   6580 | 01000              */
    {  0,   0,  '='}, /*  13 |   6628 | 01001              */
    { 15,  50,    0}, /*  14 |  13427 |                    */
    { 16,  33,    0}, /*  15 |   6706 |                    */
    { 17,  18,    0}, /*  16 |   3145 |                    */
    {  0,   0,  '-'}, /*  17 |   1525 | 0101000            */
    { 19,  22,    0}, /*  18 |   1620 |                    */
    { 20,  21,    0}, /*  19 |    801 |                    */
    {  0,   0,  '<'}, /*  20 |    399 | 010100100          */
    {  0,   0, 0xf4}, /*  21 |    402 | 010100101          */
    { 23,  24,    0}, /*  22 |    819 |                    */
    {  0,   0,  '%'}, /*  23 |    402 | 010100110          */
    { 25,  26,    0}, /*  24 |    417 |                    */
    {  0,   0,  'I'}, /*  25 |    202 | 0101001110         */
    { 27,  28,    0}, /*  26 |    215 |                    */
    {  0,   0,  'D'}, /*  27 |    105 | 01010011110        */
    { 29,  30,    0}, /*  28 |    110 |                    */
    {  0,   0,  'G'}, /*  29 |     54 | 010100111110       */
    { 31,  32,    0}, /*  30 |     56 |                    */
    {  0,   0,  '&'}, /*  31 |     27 | 0101001111110      */
    {  0,   0,  'W'}, /*  32 |     29 | 0101001111111      */
    { 34,  41,    0}, /*  33 |   3561 |                    */
    { 35,  38,    0}, /*  34 |   1733 |                    */
    { 36,  37,    0}, /*  35 |    859 |                    */
    {  0,   0,  '>'}, /*  36 |    424 | 010101000          */
    {  0,   0,  '{'}, /*  37 |    435 | 010101001          */
    { 39,  40,    0}, /*  38 |    874 |                    */
    {  0,   0,  '}'}, /*  39 |    436 | 010101010          */
    {  0,   0,  '8'}, /*  40 |    438 | 010101011          */
    { 42,  49,    0}, /*  41 |   1828 |                    */
    { 43,  44,    0}, /*  42 |    887 |                    */
    {  0,   0, '\\'}, /*  43 |    439 | 010101100          */
    { 45,  46,    0}, /*  44 |    448 |                    */
    {  0,   0,  'S'}, /*  45 |    222 | 0101011010         */
    { 47,  48,    0}, /*  46 |    226 |                    */
    {  0,   0, 0xf5}, /*  47 |    111 | 01010110110        */
    {  0,   0,  'F'}, /*  48 |    115 | 01010110111        */
    {  0,   0, 0xf3}, /*  49 |    941 | 01010111           */
    {  0,   0,  ','}, /*  50 |   6721 | 01011              */
    { 52,  59,    0}, /*  51 |  30594 |                    */
    { 53,  54,    0}, /*  52 |  14725 |                    */
    {  0,   0,  'd'}, /*  53 |   7240 | 01100              */
    { 55,  58,    0}, /*  54 |   7485 |                    */
    { 56,  57,    0}, /*  55 |   3698 |                    */
    {  0,   0,  '5'}, /*  56 |   1840 | 0110100            */
    {  0,   0,  '7'}, /*  57 |   1858 | 0110101            */
    {  0,   0,  '_'}, /*  58 |   3787 | 011011             */
    { 60,  85,    0}, /*  59 |  15869 |                    */
    { 61,  62,    0}, /*  60 |   7781 |                    */
    {  0,   0, '\''}, /*  61 |   3788 | 011100             */
    { 63,  82,    0}, /*  62 |   3993 |                    */
    { 64,  65,    0}, /*  63 |   1967 |                    */
    {  0,   0,  ':'}, /*  64 |    966 | 01110100           */
    { 66,  77,    0}, /*  65 |   1001 |                    */
    { 67,  68,    0}, /*  66 |    471 |                    */
    {  0,   0,  '#'}, /*  67 |    228 | 0111010100         */
    { 69,  72,    0}, /*  68 |    243 |                    */
    { 70,  71,    0}, /*  69 |    117 |                    */
    {  0,   0,  '@'}, /*  70 |     58 | 011101010100       */
    {  0,   0,  'z'}, /*  71 |     59 | 011101010101       */
    { 73,  76,    0}, /*  72 |    126 |                    */
    { 74,  75,    0}, /*  73 |     60 |                    */
    {  0,   0,  '$'}, /*  74 |     30 | 0111010101100      */
    {  0,   0,  'N'}, /*  75 |     30 | 0111010101101      */
    {  0,   0, 0xf6}, /*  76 |     66 | 011101010111       */
    { 78,  81,    0}, /*  77 |    530 |                    */
    { 79,  80,    0}, /*  78 |    260 |                    */
    {  0,   0,  'P'}, /*  79 |    126 | 01110101100        */
    {  0,   0,  '/'}, /*  80 |    134 | 01110101101        */
    {  0,   0,  '+'}, /*  81 |    270 | 0111010111         */
    { 83,  84,    0}, /*  82 |   2026 |                    */
    {  0,   0,  'v'}, /*  83 |   1004 | 01110110           */
    {  0,   0,  'w'}, /*  84 |   1022 | 01110111           */
    { 86,  87,    0}, /*  85 |   8088 |                    */
    {  0,   0,  '1'}, /*  86 |   3998 | 011110             */
    { 88,  89,    0}, /*  87 |   4090 |                    */
    {  0,   0, 0xf1}, /*  88 |   2039 | 0111110            */
    {  0,   0,  'b'}, /*  89 |   2051 | 0111111            */
    { 91, 126,    0}, /*  90 | 154527 |                    */
    { 92, 105,    0}, /*  91 |  72005 |                    */
    { 93,  96,    0}, /*  92 |  34696 |                    */
    { 94,  95,    0}, /*  93 |  17219 |                    */
    {  0,   0,  'r'}, /*  94 |   8507 | 10000              */
    {  0,   0,  'a'}, /*  95 |   8712 | 10001              */
    { 97, 104,    0}, /*  96 |  17477 |                    */
    { 98, 103,    0}, /*  97 |   8718 |                    */
    { 99, 102,    0}, /*  98 |   4325 |                    */
    {100, 101,    0}, /*  99 |   2104 |                    */
    {  0,   0,  '9'}, /* 100 |   1040 | 10010000           */
    {  0,   0,  'x'}, /* 101 |   1064 | 10010001           */
    {  0,   0, 0xf2}, /* 102 |   2221 | 1001001            */
    {  0,   0,  'p'}, /* 103 |   4393 | 100101             */
    {  0,   0,  'l'}, /* 104 |   8759 | 10011              */
    {106, 121,    0}, /* 105 |  37309 |                    */
    {107, 118,    0}, /* 106 |  18392 |                    */
    {108, 113,    0}, /* 107 |   9050 |                    */
    {109, 110,    0}, /* 108 |   4451 |                    */
    {  0,   0,  'g'}, /* 109 |   2224 | 1010000            */
    {111, 112,    0}, /* 110 |   2227 |                    */
    {  0,   0,  'k'}, /* 111 |   1099 | 10100010           */
    {  0,   0,  'M'}, /* 112 |   1128 | 10100011           */
    {114, 117,    0}, /* 113 |   4599 |                    */
    {115, 116,    0}, /* 114 |   2272 |                    */
    {  0,   0,  ']'}, /* 115 |   1131 | 10100100           */
    {  0,   0,  '['}, /* 116 |   1141 | 10100101           */
    {  0,   0,  'y'}, /* 117 |   2327 | 1010011            */
    {119, 120,    0}, /* 118 |   9342 |                    */
    {  0,   0,  ')'}, /* 119 |   4665 | 101010             */
    {  0,   0,  '('}, /* 120 |   4677 | 101011             */
    {122, 123,    0}, /* 121 |  18917 |                    */
    {  0,   0,  's'}, /* 122 |   9436 | 10110              */
    {124, 125,    0}, /* 123 |   9481 |                    */
    {  0,   0,  'u'}, /* 124 |   4694 | 101110             */
    {  0,   0,  'h'}, /* 125 |   4787 | 101111             */
    {127, 172,    0}, /* 126 |  82522 |                    */
    {128, 129,    0}, /* 127 |  39087 |                    */
    {  0,   0,  'e'}, /* 128 |  19009 | 1100               */
    {130, 171,    0}, /* 129 |  20078 |                    */
    {131, 170,    0}, /* 130 |  10035 |                    */
    {132, 169,    0}, /* 131 |   4981 |                    */
    {133, 168,    0}, /* 132 |   2469 |                    */
    {134, 159,    0}, /* 133 |   1219 |                    */
    {135, 156,    0}, /* 134 |    571 |                    */
    {136, 139,    0}, /* 135 |    277 |                    */
    {137, 138,    0}, /* 136 |    135 |                    */
    {  0,   0,  '~'}, /* 137 |     67 | 110100000000       */
    {  0,   0,  'V'}, /* 138 |     68 | 110100000001       */
    {140, 141,    0}, /* 139 |    142 |                    */
    {  0,   0,  'H'}, /* 140 |     68 | 110100000010       */
    {142, 155,    0}, /* 141 |     74 |                    */
    {143, 152,    0}, /* 142 |     37 |                    */
    {144, 145,    0}, /* 143 |     17 |                    */
    {  0,   0, 0xf8}, /* 144 |      8 | 110100000011000    */
    {146, 147,    0}, /* 145 |      9 |                    */
    {  0,   0,  'Y'}, /* 146 |      3 | 1101000000110010   */
    {148, 151,    0}, /* 147 |      6 |                    */
    {149, 150,    0}, /* 148 |      3 |                    */
    {  0,   0, 0xf9}, /* 149 |      1 | 110100000011001100 */
    {  0,   0,  '!'}, /* 150 |      2 | 110100000011001101 */
    {  0,   0,  'X'}, /* 151 |      3 | 11010000001100111  */
    {153, 154,    0}, /* 152 |     20 |                    */
    {  0,   0,  '^'}, /* 153 |     10 | 110100000011010    */
    {  0,   0,  '?'}, /* 154 |     10 | 110100000011011    */
    {  0,   0,  'B'}, /* 155 |     37 | 1101000000111      */
    {157, 158,    0}, /* 156 |    294 |                    */
    {  0,   0,  'C'}, /* 157 |    146 | 11010000010        */
    {  0,   0,  'T'}, /* 158 |    148 | 11010000011        */
    {160, 161,    0}, /* 159 |    648 |                    */
    {  0,   0,  'q'}, /* 160 |    320 | 1101000010         */
    {162, 165,    0}, /* 161 |    328 |                    */
    {163, 164,    0}, /* 162 |    159 |                    */
    {  0,   0,  'R'}, /* 163 |     78 | 110100001100       */
    {  0,   0,  'j'}, /* 164 |     81 | 110100001101       */
    {166, 167,    0}, /* 165 |    169 |                    */
    {  0,   0,  'U'}, /* 166 |     84 | 110100001110       */
    {  0,   0,  ';'}, /* 167 |     85 | 110100001111       */
    {  0,   0,  '4'}, /* 168 |   1250 | 11010001           */
    {  0,   0,  '2'}, /* 169 |   2512 | 1101001            */
    {  0,   0,  'c'}, /* 170 |   5054 | 110101             */
    {  0,   0,  'i'}, /* 171 |  10043 | 11011              */
    {173, 176,    0}, /* 172 |  43435 |                    */
    {174, 175,    0}, /* 173 |  20630 |                    */
    {  0,   0, '\n'}, /* 174 |  10304 | 11100              */
    {  0,   0,  'o'}, /* 175 |  10326 | 11101              */
    {177, 206,    0}, /* 176 |  22805 |                    */
    {178, 179,    0}, /* 177 |  11126 |                    */
    {  0,   0,  'f'}, /* 178 |   5556 | 111100             */
    {180, 183,    0}, /* 179 |   5570 |                    */
    {181, 182,    0}, /* 180 |   2633 |                    */
    {  0,   0,  '"'}, /* 181 |   1277 | 11110100           */
    {  0,   0,  '6'}, /* 182 |   1356 | 11110101           */
    {184, 205,    0}, /* 183 |   2937 |                    */
    {185, 204,    0}, /* 184 |   1444 |                    */
    {186, 191,    0}, /* 185 |    714 |                    */
    {187, 190,    0}, /* 186 |    342 |                    */
    {188, 189,    0}, /* 187 |    171 |                    */
    {  0,   0,  'L'}, /* 188 |     85 | 111101100000       */
    {  0,   0,  '*'}, /* 189 |     86 | 111101100001       */
    {  0,   0,  'E'}, /* 190 |    171 | 11110110001        */
    {192, 195,    0}, /* 191 |    372 |                    */
    {193, 194,    0}, /* 192 |    176 |                    */
    {  0,   0,  '`'}, /* 193 |     87 | 111101100100       */
    {  0,   0,  'A'}, /* 194 |     89 | 111101100101       */
    {196, 203,    0}, /* 195 |    196 |                    */
    {197, 198,    0}, /* 196 |     93 |                    */
    {  0,   0,  'O'}, /* 197 |     41 | 1111011001100      */
    {199, 200,    0}, /* 198 |     52 |                    */
    {  0,   0, 0xf7}, /* 199 |     25 | 11110110011010     */
    {201, 202,    0}, /* 200 |     27 |                    */
    {  0,   0,  'K'}, /* 201 |     12 | 111101100110110    */
    {  0,   0,  'Q'}, /* 202 |     15 | 111101100110111    */
    {  0,   0,  '|'}, /* 203 |    103 | 111101100111       */
    {  0,   0,  '3'}, /* 204 |    730 | 111101101          */
    {  0,   0, 0xf0}, /* 205 |   1493 | 11110111           */
    {  0,   0,  'n'}, /* 206 |  11679 | 11111              */
};

char const* hh2_bsDecode(void const* const data, size_t* const size) {
    uint8_t const* bits = (uint8_t const*)data;
    size_t const count = bits[0] | bits[1] << 8 | bits[2] << 16 | bits[3] << 24;
    *size = count;
    bits += 4;

    char* decoded = (char*)malloc(*size);

    if (decoded == NULL) {
        return NULL;
    }

    char const* const result = decoded;
    char const* const end = decoded + count;
    uint8_t bit = 0x80;

    while (decoded < end) {
        uint16_t node = 0;

        while (hh2_BsTree[node].symbol == 0) {
            node = (*bits & bit) == 0 ? hh2_BsTree[node].left : hh2_BsTree[node].right;

            if ((bit >>= 1) == 0) {
                bits++;
                bit = 0x80;
            }
        }

        switch (hh2_BsTree[node].symbol) {
            case 0xf0: case 0xf1: case 0xf2: case 0xf3: case 0xf4: case 0xf5: case 0xf6: case 0xf7:
            case 0xf8: case 0xf9: case 0xfa: case 0xfb: case 0xfc: case 0xfd: case 0xfe: case 0xff:
                for (int i = (hh2_BsTree[node].symbol & 0x0f) * 4; i >= 0 && decoded < end; i--) {
                    *decoded++ = ' ';
                }

                break;

            default:
                *decoded++ = hh2_BsTree[node].symbol;
        }
    }

    return result;
}
